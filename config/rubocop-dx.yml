# rubocop-dx.yml - Devex shared RuboCop configuration
#
# Use this as a base for your project's .rubocop.yml:
#
#   inherit_gem:
#     devex: config/rubocop-dx.yml
#
#   AllCops:
#     TargetRubyVersion: 3.3  # Your project's Ruby version
#
#   # Project-specific overrides below...
#
# Or let `dx lint` use this automatically when no .rubocop.yml exists.
#
# Layout/alignment conventions come from rubocop-tablecop.
# This file contains the rest of the house style.

plugins:
  - rubocop-minitest
  - rubocop-tablecop

AllCops:
  NewCops: enable
  SuggestExtensions: false
  Exclude:
    - "tmp/**/*"
    - "vendor/**/*"
    - "coverage/**/*"

# ─────────────────────────────────────────────────────────────────────────────
# Style
# ─────────────────────────────────────────────────────────────────────────────

# Allow both single and double quotes - use double by convention,
# single when semantically meaningful (e.g., JSON-style string keys)
Style/StringLiterals:
  Enabled: false

# Prefer explicit bracket syntax for symbol arrays
Style/SymbolArray:
  EnforcedStyle: brackets

# Prefer %w[] for word arrays
Style/WordArray:
  EnforcedStyle: percent

# Allow multi-line block chains when readable
Style/MultilineBlockChain:
  Enabled: false

# DANGEROUS: Autocorrect converts !!value to !value.nil? which has
# different semantics for boolean values (!!false -> false, !false.nil? -> true)
Style/DoubleNegation:
  Enabled: false

# DANGEROUS: Changes semantics with mixed key types.
# reject { |k, _| keys.include?(k) } handles symbol/string keys correctly,
# but hash.except(*keys) treats :key and "key" as different.
Style/HashExcept:
  Enabled: false

# DANGEROUS: Converts `Module % [args]` to `format(Module, args)` which breaks
# custom % methods (like ANSI % ["text", :style] for nested color spans).
Style/FormatString:
  Enabled: false

# ─────────────────────────────────────────────────────────────────────────────
# Layout
# ─────────────────────────────────────────────────────────────────────────────

Layout/LineLength:
  Max: 140

# Allow RBS inline type comments like #: Type
Layout/LeadingCommentSpace:
  AllowRBSInlineAnnotation: true

# ─────────────────────────────────────────────────────────────────────────────
# Naming
# ─────────────────────────────────────────────────────────────────────────────

# DISABLED: Renames @foo_instance to @foo, but tests often use
# instance_variable_set(:@foo_instance, nil) to reset memoized state.
Naming/MemoizedInstanceVariableName:
  Enabled: false

# DISABLED: Too pedantic about underscores in numbers (last_5, chain_from_11)
Naming/VariableNumber:
  Enabled: false

# Allow common short parameter names
Naming/MethodParameterName:
  AllowedNames:
    - a
    - b
    - c
    - e   # exception, element, entry
    - i   # index
    - j   # secondary index
    - k   # key
    - v   # value
    - h   # hash
    - n   # number, count
    - x   # coordinate, generic
    - y   # coordinate
    - id  # identifier
    - io  # IO object
    - op  # operation
    - db  # database
    - fn  # function
    - to  # destination (from:, to:)
    - of  # element type (array of:)
    - _   # explicitly unused

# ─────────────────────────────────────────────────────────────────────────────
# Lint
# ─────────────────────────────────────────────────────────────────────────────

# DISABLED: Forces combining case branches that happen to have the same result,
# but often they represent distinct semantic intents. With tablecop alignment,
# separate branches read as visual lookup tables which is clearer.
Lint/DuplicateBranch:
  Enabled: false

Lint/UnusedMethodArgument:
  AllowUnusedKeywordArguments: true
  IgnoreEmptyMethods: true

# DISABLED: Too strict for mixins and decorators
Lint/MissingSuper:
  Enabled: false

# DANGEROUS: Removes `require "set"` as "redundant" in Ruby 3.2+, but code
# using Set.new will fail if Set isn't explicitly required in some contexts.
Lint/RedundantRequireStatement:
  Enabled: false

# ─────────────────────────────────────────────────────────────────────────────
# Metrics - Lenient thresholds for real-world code
# ─────────────────────────────────────────────────────────────────────────────

Metrics/MethodLength:
  Max: 40
  CountAsOne:
    - array
    - hash
    - heredoc

Metrics/AbcSize:
  Max: 50

Metrics/CyclomaticComplexity:
  Max: 20

Metrics/PerceivedComplexity:
  Max: 15

Metrics/ClassLength:
  Max: 300
  CountAsOne:
    - array
    - hash
    - heredoc

Metrics/BlockLength:
  Max: 40
  CountAsOne:
    - array
    - hash
    - heredoc
  Exclude:
    - "test/**/*"
    - "spec/**/*"
    - "features/**/*"
  AllowedMethods:
    - describe
    - context
    - define
    - configure
    - namespace

Metrics/ParameterLists:
  Max: 15

# ─────────────────────────────────────────────────────────────────────────────
# Minitest
# ─────────────────────────────────────────────────────────────────────────────

Minitest/EmptyLineBeforeAssertionMethods:
  Enabled: false

Minitest/MultipleAssertions:
  Max: 8

# DANGEROUS: Converts `assert obj.foo?` to `assert_predicate obj, :foo?`
# which breaks refinements since assert_predicate uses send() internally
# and refinements are lexically scoped (don't work with send).
Minitest/AssertPredicate:
  Enabled: false

Minitest/RefutePredicate:
  Enabled: false
