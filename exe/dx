#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/devex"

# Extract --dx-from-dir before project discovery
# This flag affects where we look for the project root
argv     = ARGV.dup
from_dir = nil
argv.reject! do |arg|
  if arg.start_with?("--dx-from-dir=")
    from_dir = arg.split("=", 2).last
    true
  elsif arg == "--dx-from-dir" && argv.index(arg) < argv.size - 1
    # Handle --dx-from-dir PATH (space-separated)
    idx = argv.index(arg)
    from_dir = argv[idx + 1]
    begin
      argv.delete_at(idx + 1)
    rescue StandardError
      nil
    end
    true
  else
    false
  end
end

# Set dest_dir if --dx-from-dir was provided
Devex::Dirs.dest_dir = File.expand_path(from_dir) if from_dir

# Check for .dx-use-local and delegate to bundled dx if present
# This ensures version consistency when a project pins a specific devex version
Devex::Dirs.maybe_delegate_to_local!(config: Devex::DX_CONFIG, argv: argv)

# Create CLI with dx configuration
cli = Devex::CLI.new(config: Devex::DX_CONFIG)

# Load built-in tools
cli.load_builtins

# Find project root and load project tools
# Use from_dir if provided, otherwise search from current directory
search_from = from_dir ? File.expand_path(from_dir) : Dir.pwd
project_root, _marker = Devex.find_project_root(search_from)
cli.load_project_tools(project_root) if project_root

# Merge builtins (project takes precedence)
cli.merge_builtins

# Run
exit cli.run(argv)
